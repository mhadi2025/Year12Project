@model RevisionPlanner.Models.ViewModels.CreateTimetableViewModel
@using RevisionPlanner.Enums
@using System.Collections.Generic

@{
    var usedIds = ViewBag.UsedSubjectIds as List<int> ?? new List<int>();
    var usedSet = new HashSet<int>(usedIds);

    var hasExistingSubjects = Model.Subjects.Any(s => s.Id != 0);
    ViewData["Title"] = hasExistingSubjects ? "Update Timetable" : "Create Timetable";
    var submitLabel = hasExistingSubjects ? "Update Timetable" : "Create Timetable";

    string DotClass(DifficultyLevel d) =>
        d == DifficultyLevel.Easy ? "dot-easy" :
        d == DifficultyLevel.Medium ? "dot-medium" :
        "dot-hard";

    string BorderClass(DifficultyLevel d) =>
        d == DifficultyLevel.Easy ? "border-easy" :
        d == DifficultyLevel.Medium ? "border-medium" :
        "border-hard";
}

<h2>@ViewData["Title"]</h2>
<p class="text-muted mb-3">
    Add subjects, exam dates, and difficulty.
</p>

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()

    <div asp-validation-summary="All" class="text-danger mb-3"></div>

    <table class="table align-middle">
        <thead>
            <tr>
                <th style="width:40%">Subject</th>
                <th style="width:25%">Exam Date</th>
                <th style="width:25%">Difficulty</th>
                <th style="width:10%"></th>
            </tr>
        </thead>

        <tbody id="subjectRows">
            @for (int i = 0; i < Model.Subjects.Count; i++)
            {
                var subjectId = Model.Subjects[i].Id;
                var isUsed = subjectId != 0 && usedSet.Contains(subjectId);

                int? daysToExamRow = Model.Subjects[i].ExamDate.HasValue
                ? (int?)(Model.Subjects[i].ExamDate.Value.Date - DateTime.Today.Date).TotalDays
                : null;

                string rowBadgeClass =
                daysToExamRow.HasValue && daysToExamRow.Value <= 2 ? "badge-soon" :
                daysToExamRow.HasValue && daysToExamRow.Value <= 7 ? "badge-upcoming" : "";

                string rowBadgeText =
                !daysToExamRow.HasValue ? "" :
                daysToExamRow.Value < 0 ? "Exam passed" :
                daysToExamRow.Value == 0 ? "Exam today" :
                daysToExamRow.Value == 1 ? "Exam in 1 day" :
                $"Exam in {daysToExamRow.Value} days";

                <tr class="subject-row">
                    <td>
                        <input type="hidden" asp-for="Subjects[@i].Id" />
                        <input asp-for="Subjects[@i].SubjectName" class="form-control" placeholder="e.g., Maths" />
                        <span asp-validation-for="Subjects[@i].SubjectName" class="text-danger"></span>
                    </td>

                    <td>
                        <div class="d-flex gap-2 align-items-center">
                            <input asp-for="Subjects[@i].ExamDate" type="date" class="form-control" />
                            @if (daysToExamRow.HasValue && daysToExamRow.Value >= 0 && daysToExamRow.Value <= 7)
                            {
                                <span class="exam-badge @rowBadgeClass">@rowBadgeText</span>
                            }
                        </div>
                    </td>

                    <td>
                        <div class="d-flex align-items-center gap-3">
                            <span class="difficulty-dot @DotClass(Model.Subjects[i].Difficulty)"></span>

                            <select asp-for="Subjects[@i].Difficulty"
                                    class="form-select difficulty-select @BorderClass(Model.Subjects[i].Difficulty)"
                                    asp-items="Html.GetEnumSelectList<DifficultyLevel>()">
                            </select>
                        </div>
                    </td>

                    <td class="text-end">
                        <button type="button"
                                class="btn btn-outline-danger btn-sm delete-row"
                                title="@(isUsed ? "This subject is being used in the timetable" : "Delete")"
                                @(isUsed ? "disabled" : "")>
                            ✕
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex gap-2">
        <button type="button" id="addRow" class="btn btn-secondary">
            + Add Subject
        </button>

        <button type="submit" class="btn btn-primary">
            @submitLabel
        </button>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <style>
        .difficulty-dot {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid rgba(0,0,0,.15);
        }

        .dot-easy {
            background: #2ecc71;
        }

        .dot-medium {
            background: #f1c40f;
        }

        .dot-hard {
            background: #e74c3c;
        }

        .border-easy {
            border: 2px solid #2ecc71 !important;
        }

        .border-medium {
            border: 2px solid #f1c40f !important;
        }

        .border-hard {
            border: 2px solid #e74c3c !important;
        }

        .difficulty-select:focus {
            box-shadow: 0 0 0 0.2rem rgba(0,0,0,.08) !important;
        }

        .exam-badge {
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(0,0,0,.12);
            font-weight: 700;
            font-size: 12px;
            background: #fff;
            white-space: nowrap;
        }

        .badge-soon {
            background: rgba(220,53,69,.18);
        }

        .badge-upcoming {
            background: rgba(241,196,15,.25);
        }
    </style>

    <script>
        (function () {
            const tbody = document.getElementById("subjectRows");
            const addBtn = document.getElementById("addRow");

            function normalizeDifficultyValue(val) {
                const v = (val ?? "").toString().toLowerCase().trim();
                if (v === "1" || v.includes("easy")) return "easy";
                if (v === "2" || v.includes("medium")) return "medium";
                if (v === "3" || v.includes("hard")) return "hard";
                return "";
            }

            function applyDifficultyStyles(row) {
                const select = row.querySelector(".difficulty-select");
                const dot = row.querySelector(".difficulty-dot");
                if (!select || !dot) return;

                dot.classList.remove("dot-easy", "dot-medium", "dot-hard");
                select.classList.remove("border-easy", "border-medium", "border-hard");

                const d = normalizeDifficultyValue(select.value);
                if (d === "easy") {
                    dot.classList.add("dot-easy");
                    select.classList.add("border-easy");
                } else if (d === "medium") {
                    dot.classList.add("dot-medium");
                    select.classList.add("border-medium");
                } else if (d === "hard") {
                    dot.classList.add("dot-hard");
                    select.classList.add("border-hard");
                }
            }

            function wireRow(row) {
                applyDifficultyStyles(row);

                const select = row.querySelector(".difficulty-select");
                if (select) select.addEventListener("change", () => applyDifficultyStyles(row));

                const del = row.querySelector(".delete-row");
                if (del) {
                    del.addEventListener("click", () => {
                        if (del.disabled) return;
                        row.remove();
                        reindex();
                    });
                }
            }

            function reindex() {
                const rows = tbody.querySelectorAll("tr.subject-row");
                rows.forEach((row, i) => {
                    row.querySelectorAll("input, select").forEach(el => {
                        if (el.name) el.name = el.name.replace(/Subjects\[\d+\]/g, `Subjects[${i}]`);
                        if (el.id) el.id = el.id.replace(/Subjects_\d+__/g, `Subjects_${i}__`);
                    });
                });
            }

            addBtn.addEventListener("click", () => {
                const index = tbody.querySelectorAll("tr.subject-row").length;

                const tr = document.createElement("tr");
                tr.className = "subject-row";
                tr.innerHTML = `
                    <td>
                        <input type="hidden" name="Subjects[${index}].Id" value="0" />
                        <input name="Subjects[${index}].SubjectName" class="form-control" placeholder="e.g., Science" />
                    </td>
                    <td>
                        <input name="Subjects[${index}].ExamDate" type="date" class="form-control" />
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-3">
                            <span class="difficulty-dot dot-easy"></span>
                            <select name="Subjects[${index}].Difficulty"
                                    class="form-select difficulty-select border-easy">
                                <option value="Easy">Easy</option>
                                <option value="Medium">Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                    </td>
                    <td class="text-end">
                        <button type="button"
                                class="btn btn-outline-danger btn-sm delete-row"
                                title="Delete">
                            ✕
                        </button>
                    </td>
                `;

                tbody.appendChild(tr);
                wireRow(tr);
            });

            tbody.querySelectorAll("tr.subject-row").forEach(wireRow);
        })();
    </script>
}
